use customer_behavior;

SELECT * FROM CUSTOMER;

-- SOME BUSINESS RELATED QUESTION 

-- Q1. What is the total revenue generated by male vs. female customers?
SELECT GENDER, SUM(PURCHASE_AMOUNT)
FROM customer
GROUP BY GENDER;

-- Q2 Which customers used a discount but still spent more than the average purchase amount?
SELECT CUSTOMER_ID, PURCHASE_AMOUNT
FROM CUSTOMER 
WHERE DISCOUNT_APPLIED = 'YES' AND PURCHASE_AMOUNT>= (SELECT AVG(PURCHASE_AMOUNT) FROM CUSTOMER);

-- Q3 Which are the top 5 products with the highest average review rating?
SELECT ITEM_PURCHASED,AVG(REVIEW_RATING)
FROM CUSTOMER
GROUP BY ITEM_PURCHASED
ORDER BY AVG(REVIEW_RATING) DESC
LIMIT 5;

-- Q4 Compare the average Purchase Amounts between Standard and Express Shipping.
SELECT SHIPPING_TYPE, AVG(PURCHASE_AMOUNT)
FROM CUSTOMER
WHERE SHIPPING_TYPE IN ('EXPRESS','STANDARD')
GROUP BY SHIPPING_TYPE;

-- Q5 Do subscribed customers spend more? Compare average spend and total revenue
-- between subscribers and non-subscribers
SELECT SUBSCRIPTION_STATUS,
COUNT(CUSTOMER_ID),
AVG(PURCHASE_AMOUNT) AS AVERAGE_SPEND,
SUM(PURCHASE_AMOUNT) AS TOTAL_REVENUE
FROM CUSTOMER
GROUP BY SUBSCRIPTION_STATUS
ORDER BY AVERAGE_SPEND, TOTAL_REVENUE DESC;

-- Q6. Which 5 products have the highest percentage of purchases with discounts applied?
SELECT ITEM_PURCHASED,
(100 * SUM(CASE WHEN DISCOUNT_APPLIED ='YES' THEN 1 ELSE 0 END)/COUNT(*)) AS DISCOUNT_RATE
FROM CUSTOMER
GROUP BY ITEM_PURCHASED
ORDER BY DISCOUNT_RATE DESC
LIMIT 5;


-- Q7. Segment customers into New, Returning, and Loyal based on their total number of previous purchases, 
-- and show the count of each segment
with CUSTOMER_TYPE AS(
SELECT CUSTOMER_ID, PREVIOUS_PURCHASES,
CASE
    WHEN PREVIOUS_PURCHASES = 1 THEN 'NEW'
    WHEN PREVIOUS_PURCHASES BETWEEN 2 AND 10 THEN 'RETURNING'
    ELSE 'LOYAL'
    END AS CUSTOMER_SEGMENT
FROM CUSTOMER
)

SELECT CUSTOMER_SEGMENT, COUNT(*) AS "NUMBER OF CUSTOMERS"
FROM CUSTOMER_TYPE
GROUP BY CUSTOMER_SEGMENT;

-- Q8. What are the top 3 most purchased products within each category?
WITH ITEM_COUNTS AS(
SELECT CATEGORY,
ITEM_PURCHASED,
COUNT(CUSTOMER_ID) AS TOTAL_ORDERS,
ROW_NUMBER() OVER(PARTITION BY CATEGORY ORDER BY COUNT(CUSTOMER_ID) DESC) AS ITEM_RANK
FROM CUSTOMER
GROUP BY CATEGORY, ITEM_PURCHASED
)
SELECT ITEM_RANK,CATEGORY,ITEM_PURCHASED,TOTAL_ORDERS
FROM ITEM_COUNTS
WHERE ITEM_RANK <= 3;



